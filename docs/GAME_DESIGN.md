# Game Design Document - D&D AN

## Overview

D&D AN is a roguelike RPG that combines classic Advanced Dungeons & Dragons mechanics with modern AI technology. An AI Dungeon Master generates dynamic narratives while Stable Diffusion creates pixel art scenes for each frame of gameplay.

## Core Concept

**"Every frame is a painting"** - Instead of using pre-made tile graphics, each view is a unique 160x100 pixel art image generated by AI based on the current game state. Smart caching ensures revisited locations load instantly.

## Design Pillars

### 1. Authenticity
- True AD&D 1st/2nd Edition rules
- THAC0 combat system
- Vancian magic (memorization-based spells)
- Classic D&D classes, races, and monsters
- Authentic ability score modifiers

### 2. AI-Driven Narrative
- Dynamic storytelling by Claude AI
- **LangChain-powered NPC agents** with autonomous behavior
- Contextual quest generation
- Meaningful NPC interactions with memory
- Adaptive difficulty

### 3. Visual Nostalgia
- 160x100 resolution (Pool of Radiance era)
- 256-color EGA palette aesthetic
- Pixel-perfect rendering
- Retro UI design

### 4. Modern Architecture
- TypeScript for type safety
- Client-server architecture
- Efficient caching system
- Progressive web app capabilities

## Gameplay Loop

```
Explore → Encounter → Combat → Loot → Rest → Explore
           ↓
      AI Narration
```

### Exploration Phase
1. Player moves one tile at a time
2. Can rotate 90° to change facing
3. Scene generated/cached for current view
4. Fog of war reveals map as explored
5. Random encounter checks
6. Environmental interaction

### Combat Phase
1. Initiative rolled (1d10 + DEX modifier)
2. Turn-based actions in initiative order
3. Attack rolls using THAC0 system
4. Damage applied, status effects checked
5. Morale checks for monsters
6. XP awarded on victory

### Character Progression
1. Gain XP from combat and quests
2. Level up when threshold reached
3. Roll hit points (class hit die + CON)
4. THAC0 improves
5. Spell slots increase
6. Saving throws improve

## Core Systems

### Movement System

**Grid-Based Tile Movement**
- Move exactly one tile per action
- Four cardinal directions only
- 90-degree rotation
- Movement blocked by walls, locked doors
- Entities (monsters, NPCs) block movement

**View State**
```typescript
{
  position: { x, y },
  facing: 'North' | 'South' | 'East' | 'West'
}
```

### Scene Generation

**Pipeline**:
1. Calculate view hash: `SHA256(position + facing + entities + lighting)`
2. Check cache for hash
3. If hit: Load cached image (< 50ms)
4. If miss: Generate via SD API (3-8 seconds)
5. Store in cache
6. Display image

**Prompt Template**:
```
160x100 pixel art, 256-color EGA palette, retro RPG style,
top-down view, [location], [entities], [lighting],
inspired by Pool of Radiance, classic D&D aesthetic
```

**Cache Strategy**:
- LRU eviction when full
- 500 entry default limit
- Persistent between sessions
- ~10-50 KB per image

### Combat System (THAC0)

**To Hit Calculation**:
```
Attack Roll: 1d20 + STR bonus
Hit if: Roll ≥ (THAC0 - Target AC)
```

**Example**:
- Fighter THAC0: 18
- Orc AC: 6
- Need: 18 - 6 = 12+
- With +2 STR: Need 10+ on d20

**Critical Hits**:
- Natural 20 always hits
- Roll maximum weapon damage + normal roll
- Doubles damage bonus

**Saving Throws**:
Five categories, each with target number:
1. Death Magic / Poison
2. Wands / Rods
3. Paralysis / Turn to Stone
4. Breath Weapon
5. Spells / Staves

Roll 1d20 ≥ target to succeed.

### Character Classes

#### Fighter
- **Hit Die**: d10
- **THAC0**: Best progression (improves every level)
- **Strengths**: High HP, best weapons/armor
- **Weaknesses**: No magic

#### Cleric
- **Hit Die**: d8
- **THAC0**: Moderate progression
- **Spells**: Divine magic (healing, protection)
- **Strengths**: Healing, undead turning
- **Weaknesses**: Limited weapon selection

#### Magic-User
- **Hit Die**: d4
- **THAC0**: Worst progression
- **Spells**: Arcane magic (offense, utility)
- **Strengths**: Powerful spells
- **Weaknesses**: Fragile, no armor

#### Thief
- **Hit Die**: d6
- **THAC0**: Moderate progression
- **Strengths**: Backstab, trap/lock skills
- **Weaknesses**: Low HP, limited combat

#### Ranger
- **Hit Die**: d10
- **THAC0**: Fighter progression
- **Spells**: Limited druid magic
- **Strengths**: Tracking, outdoor bonus
- **Weaknesses**: Strict alignment (Good only)

#### Paladin
- **Hit Die**: d10
- **THAC0**: Fighter progression
- **Spells**: Limited cleric magic
- **Strengths**: Lay on hands, detect evil
- **Weaknesses**: Strict code of conduct

### AI Dungeon Master

**Responsibilities**:
1. **Narrative**: Describe environments, events, outcomes
2. **NPCs**: Generate dialogue, personalities, motivations (with LangChain agents)
3. **Quests**: Create goals, hooks, rewards
4. **Combat**: Narrate attacks, victories, defeats
5. **Atmosphere**: Set tone, build tension

**Prompt Engineering**:
```
You are an experienced Dungeon Master for AD&D 1st/2nd Edition.
Your narration is atmospheric, engaging, and true to classic fantasy.
Keep responses concise but evocative. Use vivid sensory details.
Maintain the spirit of old-school D&D - challenging but fair.
```

**Context Management**:
- Last 20 messages retained
- Key events summarized
- Party state tracked
- Location history maintained

### LangChain NPC Agent System

**Architecture**:
Each NPC is controlled by an autonomous LangChain agent powered by Claude Sonnet 4.5.

**12 NPC Archetypes**:
- Merchant, Guard, Innkeeper, QuestGiver
- Hermit, Priest, Thief, Noble
- Peasant, Scholar, Blacksmith, Mysterious Stranger

**Agent Capabilities**:
1. **Dialogue**: Context-aware conversations based on personality
2. **Memory**: Remembers past interactions (last 50)
3. **Relationships**: Tracks relationship levels with party members
4. **Decision-Making**: Autonomous actions based on situation
5. **Learning**: Accumulates knowledge about the world

**Persona System**:
Each NPC has:
- **Personality Traits**: Defines behavior patterns
- **Motivations**: Drives their actions and goals
- **Knowledge Areas**: What they know about
- **Speech Patterns**: How they communicate
- **Alignment**: Affects initial relationship

**Memory System**:
```typescript
{
  interactions: InteractionMemory[],  // Last 50 conversations
  facts: string[],                    // Learned information
  relationships: Map<string, Level>,  // Party member relationships
  lastUpdated: timestamp
}
```

**Relationship Levels**:
- Hostile → Unfriendly → Neutral → Friendly → Allied

**Example Interaction Flow**:
1. Player approaches NPC (within 1 tile)
2. NPC agent generates greeting based on:
   - Archetype personality
   - Previous interactions
   - Current relationship level
   - Context (location, time, events)
3. Player chooses dialogue option
4. Agent processes input through LangChain
5. Generates contextual response
6. Updates memory and relationship
7. Continues conversation or ends

See [NPC Agent System Documentation](NPC_AGENT_SYSTEM.md) for complete details.

### Dungeon Generation

**BSP Algorithm**:
1. Start with full map area
2. Recursively split into smaller sections
3. Create rooms in leaf nodes
4. Connect rooms with corridors
5. Add doors, traps, secrets

**Room Types**:
- **Chamber**: Standard room, potential encounters
- **Corridor**: Connecting passage
- **Treasure Room**: Locked, contains valuables
- **Boss Room**: Major encounter
- **Start Room**: Player spawn point

**Difficulty Scaling**:
- Monster HD increases with dungeon level
- Treasure quality improves
- Trap complexity increases
- More special abilities on monsters

### Spell System

**Vancian Magic** (Memorization-Based):
1. Rest for 8 hours
2. Select spells to memorize from known list
3. Fill available spell slots by level
4. Cast spell (one-time use)
5. Empty slot cannot be reused until next rest

**Spell Slots by Class/Level**:
```
Magic-User Level 1: 1 × 1st level
Magic-User Level 3: 2 × 1st, 1 × 2nd
Cleric Level 1: 1 × 1st level
```

**Sample Spells**:
- **Magic Missile** (Arcane 1): Auto-hit, 1d4+1 damage per missile
- **Sleep** (Arcane 1): 2d8 HD of creatures fall asleep
- **Cure Light Wounds** (Divine 1): Heal 1d8 HP
- **Fireball** (Arcane 3): 1d6 damage per caster level (save for half)

## UI/UX Design

### Screen Layout (960x600)

```
┌─────────────────────────────────────────────┐
│  Scene View (320x200)         Stats Panel  │
│  ┌──────────────────┐          ┌─────────┐ │
│  │                  │          │ Thorin  │ │
│  │  Generated       │          │ Dwarf   │ │
│  │  Pixel Art       │          │ Fighter │ │
│  │  Scene           │          │ Level 3 │ │
│  │  160x100         │          │         │ │
│  │  (2x scaled)     │          │ HP:24/28│ │
│  │                  │          │ AC: 5   │ │
│  └──────────────────┘          │ THAC0:17│ │
│                                │         │ │
│  ┌──────────────────────────┐ │ STR: 16 │ │
│  │ Message Log              │ │ INT: 10 │ │
│  │ > You enter a chamber... │ │ ...     │ │
│  │ > A goblin appears!      │ └─────────┘ │
│  │ > You attack for 8 dmg!  │             │
│  └──────────────────────────┘             │
└─────────────────────────────────────────────┘
```

### Color Palette (EGA-Inspired)

```
Black:   #000000
Blue:    #0000AA
Green:   #00AA00
Cyan:    #00AAAA
Red:     #AA0000
Magenta: #AA00AA
Brown:   #AA5500
White:   #AAAAAA
Gray:    #555555
...etc (16 base colors + variants)
```

### Controls

| Key | Action |
|-----|--------|
| Arrow / WASD | Move |
| Q / E | Rotate |
| Space | Interact |
| C | Character Sheet |
| I | Inventory |
| M | Cast Spell |
| R | Rest |
| ESC | Menu |

### Feedback

- **Movement**: Directional message + scene update
- **Combat Hit**: Green message, damage number
- **Combat Miss**: Gray message, "Miss!" text
- **Critical**: Yellow "CRITICAL HIT!" message
- **Level Up**: Yellow "LEVEL UP!" message
- **Death**: Red "You have fallen!" message

## Content Design

### Starting Dungeon: "The Crypts of Ashnar"

**Theme**: Ancient burial chambers, undead horrors

**Level 1**:
- Monsters: Skeletons, Zombies, Giant Rats
- Encounters: 5-10 encounters
- Treasure: 100-500 GP, basic magic items
- Boss: Skeleton Champion (3 HD)

**Level 2**:
- Monsters: Ghouls, Shadows, Stirges
- Encounters: 8-15 encounters
- Treasure: 500-1500 GP, +1 weapons
- Boss: Ghoul Lord (5 HD)

**Level 3**:
- Monsters: Wights, Wraiths, Mummies
- Encounters: 10-20 encounters
- Treasure: 1500-5000 GP, +2 items
- Boss: Lich (8 HD, spells)

### Monster Roster

**Common (CR 1-2)**:
- Goblin, Kobold, Orc
- Giant Rat, Giant Spider
- Skeleton, Zombie

**Uncommon (CR 3-5)**:
- Ogre, Hobgoblin, Gnoll
- Ghoul, Shadow, Wight
- Gelatinous Cube, Rust Monster

**Rare (CR 6-8)**:
- Troll, Minotaur, Owlbear
- Wraith, Mummy, Vampire Spawn
- Young Dragon (various colors)

**Boss (CR 9+)**:
- Adult Dragon
- Lich
- Beholder
- Demon/Devil

### Magic Items

**Common**:
- Potion of Healing (1d8+1 HP)
- Scroll of Magic Missile
- +1 Sword/Armor

**Uncommon**:
- Potion of Heroism (+2 to hit, +2 damage, 1 hour)
- Ring of Protection +1 (AC and saves)
- +2 Weapon

**Rare**:
- Potion of Extra Healing (3d8+3 HP)
- Wand of Magic Missiles (20 charges)
- +3 Weapon
- Cloak of Displacement (AC -2, save +2)

**Very Rare**:
- Potion of Invulnerability (immune to non-magical weapons)
- Staff of Power (many spell effects)
- Holy Avenger +5 Sword
- Ring of Wishes (1-3 wishes)

## Balancing

### XP Progression

```
Level 1→2: 2000 XP (Fighter)
Level 2→3: 4000 XP
Level 3→4: 8000 XP
```

**XP Sources**:
- Combat: Monster XP value
- Quests: 100-1000 XP per quest
- Treasure: 1 XP per GP value
- Exploration: 10 XP per room discovered

### Encounter Difficulty

**Easy**: Total monster HD = Party Level
**Medium**: Total monster HD = Party Level × 1.5
**Hard**: Total monster HD = Party Level × 2
**Deadly**: Total monster HD = Party Level × 3

**Example** (Level 3 party of 4):
- Easy: 3 HD total (3 Goblins)
- Medium: 4-5 HD (1 Ogre)
- Hard: 6 HD (2 Ogres)
- Deadly: 9 HD (1 Troll)

### Treasure Distribution

**Per Encounter**:
- Coins: 1d6 × 10 GP × (Monster HD)
- Magic Item: 10% chance for HD 1-2, 25% for HD 3-5, 50% for HD 6+

**Treasure Rooms**:
- 5d6 × 100 GP
- 1d4 magic items
- Possible trap (save vs. Paralysis or take 2d6 damage)

## Future Enhancements

### Phase 2 Features
- Party management (4-6 characters)
- Character portraits (AI-generated)
- Spell effects visualization
- Day/night cycle
- Weather effects

### Phase 3 Features
- Overworld map
- Towns with AI-controlled NPCs ✓
- Shops and trading (NPC agents ready)
- Character reputation (relationship system ✓)
- Multiple quest lines (NPC quest generation ready)

### Phase 4 Features
- Multiplayer (shared DM)
- User-generated content
- Custom classes/races
- Mod support
- Steam release

## Technical Considerations

### Performance Targets
- Scene cache hit: < 50ms
- Scene generation: 3-8 seconds
- Frame rate: 30+ FPS (input loop)
- Memory: < 500 MB (cache included)

### Accessibility
- Keyboard-only controls
- Screen reader support for text
- Colorblind-friendly palette options
- Adjustable text size
- Alternative visual mode (ASCII art fallback)

### Platform Support
- Modern browsers (Chrome, Firefox, Safari, Edge)
- Desktop: Windows, macOS, Linux
- Future: Mobile responsive design
- Future: Electron desktop app

## Conclusion

D&D AN represents a unique fusion of classic tabletop RPG mechanics with cutting-edge AI technology. By staying true to AD&D's roots while leveraging modern tools, the game offers both nostalgia and novelty—a familiar ruleset brought to life through dynamic AI narration and generative pixel art.

**Core Philosophy**: *Respect the past, embrace the future.*
